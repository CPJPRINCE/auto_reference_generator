name: Build Portable Executables with Nuitka

on:
  push:
    tags:
      - 'v*'
      - 'test-*'
  pull_request:
    tags:
      - 'v*'
      - 'test-*'


jobs:
  build-windows:
    name: Build Windows Portable
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install nuitka ordered-set zstandard
          pip install -e .

      - name: Build Windows executable with Nuitka
        run: |
          $tag = "${{ github.ref_name }}"
          $version = [regex]::Match($tag, '\d+\.\d+\.\d+').Value
          if ($version -eq "") { $version = "1.0.0" }
          python -m nuitka `
            --onefile `
            --output-dir=build `
            --include-package=auto_reference_generator `
            --include-data-dir=auto_reference_generator/options=auto_reference_generator/options `
            --windows-console-mode=attach `
            --company-name="Auto Reference Generator" `
            --product-name="Auto Reference Generator" `
            --file-version="$version" `
            --product-version="$version" `
            --copyright="Copyright $(Get-Date -Format yyyy)" `
            auto_reference_generator/cli.py

      - name: Rename executable
        run: |
          Rename-Item -Path "build/cli.exe" -NewName "auto_ref.exe"

      - name: Create Windows artifact archive
        run: |
          $version = "${{ github.ref_name }}" -replace "^v", ""
          Compress-Archive -Path build/auto_ref.exe -DestinationPath "auto_ref_windows_$version.zip"

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: auto_ref-windows
          path: auto_ref_windows_*.zip

      - name: Upload to release
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          files: auto_ref_windows_*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux:
    name: Build Linux Portable
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y patchelf

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install nuitka ordered-set zstandard
          pip install -e .

      - name: Build Linux executable with Nuitka
        run: |
          python -m nuitka \
            --onefile \
            --output-dir=build \
            --include-package=auto_reference_generator \
            --include-data-dir=auto_reference_generator/options=auto_reference_generator/options \
            auto_reference_generator/cli.py

      - name: Rename executable
        run: |
          ls -la build/
          find build -type f -executable ! -type d | head -1 | xargs -I {} mv {} build/auto_ref

      - name: Create Linux artifact archive
        run: |
          version="${{ github.ref_name }}"
          version="${version#v}"
          tar -czf "auto_ref_linux_${version}.tar.gz" -C build auto_ref

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: auto_ref-linux
          path: auto_ref_linux_*.tar.gz

      - name: Upload to release
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          files: auto_ref_linux_*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    name: Build macOS Portable
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install nuitka ordered-set zstandard
          pip install -e .

      - name: Build macOS executable with Nuitka
        run: |
          python -m nuitka \
            --onefile \
            --output-dir=build \
            --include-package=auto_reference_generator \
            --include-data-dir=auto_reference_generator/options=auto_reference_generator/options \
            --macos-create-app-bundle \
            auto_reference_generator/cli.py

      - name: Rename executable
        run: |
          ls -la build/
          find build -type f -executable ! -type d | head -1 | xargs -I {} mv {} build/auto_ref

      - name: Create macOS artifact archive
        run: |
          version="${{ github.ref_name }}"
          version="${version#v}"
          tar -czf "auto_ref_macos_${version}.tar.gz" -C build auto_ref

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: auto_ref-macos
          path: auto_ref_macos_*.tar.gz

      - name: Upload to release
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          files: auto_ref_macos_*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  create-release-notes:
    name: Create Release Notes
    runs-on: ubuntu-latest
    needs: [build-windows, build-linux, build-macos]
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4

      - name: Generate Release Notes
        run: |
          echo "## Portable Executables" > release_notes.md
          echo "" >> release_notes.md
          echo "### Downloads" >> release_notes.md
          echo "- **Windows**: \`auto_ref_windows_\`" >> release_notes.md
          echo "- **Linux**: \`auto_ref_linux_\`" >> release_notes.md
          echo "- **macOS**: \`auto_ref_macos_\`" >> release_notes.md
          echo "" >> release_notes.md
          echo "These are standalone executables that do not require Python to be installed." >> release_notes.md
          echo "" >> release_notes.md
          echo "### Usage" >> release_notes.md
          echo "\`\`\`bash" >> release_notes.md
          echo "./auto_ref /path/to/root -p PREFIX -o /path/to/output" >> release_notes.md
          echo "\`\`\`" >> release_notes.md
